<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>Admin Produ√ß√£o - Embaresa PT</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; min-height: 100vh; color: #e2e8f0; }
        input, select, button, textarea { font-size: 16px !important; font-family: inherit; }
        select { background: white; color: #1e293b; }
        .btn { padding: 10px 16px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #334155; color: #e2e8f0; }
        .card { background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .input { width: 100%; padding: 12px; border: 2px solid #334155; border-radius: 8px; background: #0f172a; color: #e2e8f0; }
        .input:focus { border-color: #3b82f6; outline: none; }
        input[type="date"], input[type="month"] { cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator { 
            filter: invert(1); 
            cursor: pointer;
            padding: 5px;
        }
        .label { display: block; margin-bottom: 6px; font-weight: 600; color: #94a3b8; font-size: 13px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .tab-bar { display: flex; background: #1e293b; border-bottom: 1px solid #334155; overflow-x: auto; }
        .tab-bar button { flex: 1; min-width: 80px; padding: 12px 8px; border: none; background: transparent; color: #64748b; font-size: 12px; font-weight: 600; border-bottom: 3px solid transparent; }
        .tab-bar button.active { color: #3b82f6; border-bottom-color: #3b82f6; background: #0f172a; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 6px 4px; text-align: center; border: 1px solid #334155; }
        th { background: #334155; position: sticky; top: 0; }
        .cel-verde { background: #065f46; }
        .cel-amarelo { background: #92400e; }
        .cel-vermelho { background: #991b1b; }
        .cel-azul { background: #1d4ed8; }
        .cel-roxo { background: #5b21b6; }
        .cel-cinza { background: #334155; }
        .nome-col { text-align: left !important; min-width: 120px; background: #1e293b; position: sticky; left: 0; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ============================================================
        // CONFIGURA√á√ÉO
        // ============================================================
        const CONFIG = {
            URL_LER_REGISTOS: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/630775c56a8e4ea18c0c55e5ee199828/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=nsXoJ_bRoYq09UVkNESpbL8arpQGFCWHFPnFGzpF6Go',
            URL_ELIMINAR_PROD: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e47592ecf71b45c4adce0feea2b8790b/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=M7eYa0uOBCUQtCVoAiXR_INt6qSQom9J8Wn2gulpwoU',
            URL_ELIMINAR_PERT: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/67da1332c3f941f1a5d6502babb1211d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=NHbLCe8V9zbx-P3tc55JUYlSqv5vuTWMa12f24IGnSo',
            URL_LER_PERTURBACOES: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/713deb70570a43daad73ca99c8e85755/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=_46-14d-TuRgDzRAumZLCCsUKFPTWIZ3KUKIfIDtp-E',
            URL_ALTERAR: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3fe2ae8ec3354e46b1ebd51b9de8a498/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=KpA-ybWxDWTCD6SFvjqjZYU_CfJlhpGLfa_4BPk-Uxo',
            URL_GUARDAR_MAPA: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/037823be51d04782a1f9dd7f3b1d9e94/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=xFJz3jSbLKPcesRQqJp-gjnXqFapthnDQlaAlrX8yOE',
            URL_LER_CONFIG: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/464482ea19714e50b858771991c0539d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=H29XBCpPy1dyMk7Gyj6LAWy8RKI8Q4mpUFdI5qanNKU',
            URL_ESCREVER_CONFIG: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/7ac8ac76458141b3bdbf0a981e9bf727/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=r5BztBsGszRYRdEyojb8qC5aTfPcYrxZLaMi8-eFmPE'
        };

        // ============================================================
        // DADOS BASE
        // ============================================================
        const COLABORADORES = [
            { nome: "Am√≠lcar Manuel Monginho Barreto", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "Andr√© Avelino Tavares Rocha", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "David Alexandre Lopes Rocha", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "Fernando Garcia", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "Hugo Jos√© Ferreira da Silva", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "Joaquim Comenda", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "Nuno Rafael Pereira Franco", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "Pedro Miguel Serranito Familia", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "Rui Miguel Charrua Rich√°u", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "Valdir Tavares", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true },
            { nome: "William Chaves Inaba", turno: "normal", dias: ["seg","ter","qua","qui","sex"], ativo: true }
        ];

        const ARTIGOS = [
            { artigo: "E2-Lower Dir V2", tipo: "E2" }, { artigo: "E2-Lower Esq V2", tipo: "E2" },
            { artigo: "E2-Upper Dir V2", tipo: "E2" }, { artigo: "E2-Upper Esq V2", tipo: "E2" },
            { artigo: "KC 390-Lower Dir", tipo: "KC390" }, { artigo: "KC 390-Lower Esq", tipo: "KC390" },
            { artigo: "KC 390-Upper Dir", tipo: "KC390" }, { artigo: "KC 390-Upper Esq", tipo: "KC390" },
            { artigo: "KC 390-EV", tipo: "KC390" }, { artigo: "KC 390-EH", tipo: "KC390" },
            { artigo: "Praetor-Semi Asa Dir", tipo: "Praetor" }, { artigo: "Praetor-Semi Asa Esq", tipo: "Praetor" },
            { artigo: "Praetor-EH", tipo: "Praetor" }, { artigo: "Praetor-EV", tipo: "Praetor" },
            { artigo: "Praetor-TC", tipo: "Praetor" },
            { artigo: "Caixa para Ailerons", tipo: "Praetor" }, { artigo: "Caixa para Porta Carga", tipo: "Praetor" },
            { artigo: "Caixa para Porta Rat", tipo: "Praetor" }, { artigo: "Caixa para Spoilers", tipo: "Praetor" },
            { artigo: "E2-Cx1 Desc 4Metros", tipo: "E2-Frac" }, { artigo: "E2-Frac 2", tipo: "E2-Frac" },
            { artigo: "E2-Frac 7", tipo: "E2-Frac" }, { artigo: "E2-Frac 8", tipo: "E2-Frac" },
            { artigo: "E2-Frac 9", tipo: "E2-Frac" }, { artigo: "E2-Frac 10", tipo: "E2-Frac" },
            { artigo: "E2-Frac 11", tipo: "E2-Frac" }, { artigo: "E2-Frac 12", tipo: "E2-Frac" },
            { artigo: "E2-Frac 22", tipo: "E2-Frac" },
            { artigo: "KC 390-Frac 2", tipo: "KC390-Frac" }, { artigo: "KC 390-Frac 4", tipo: "KC390-Frac" },
            { artigo: "KC 390-Frac 6", tipo: "KC390-Frac" }, { artigo: "KC 390-Frac 13", tipo: "KC390-Frac" },
            { artigo: "KC 390-Wing tip", tipo: "KC390-Frac" },
            { artigo: "E1-Embalagem A", tipo: "E1-Frac" }, { artigo: "E1-Embalagem F", tipo: "E1-Frac" },
            { artigo: "E1-Embalagem G", tipo: "E1-Frac" }, { artigo: "E1-Embalagem NMF", tipo: "E1-Frac" },
            { artigo: "Cxs sobras refor√ßadas", tipo: "Maquinacao" },
            { artigo: "Cxs sobras tipo jaula 1200", tipo: "Maquinacao" },
            { artigo: "Cxs sobras tipo jaula 1600", tipo: "Maquinacao" },
            { artigo: "Cxs sobras tipo jaula 1600x1200x800", tipo: "Maquinacao" },
            { artigo: "Transporte", tipo: "Transporte" }
        ];

        const OPERACOES = [
            "E2-Montagem e revestimento integral de suportes",
            "E2- Soldadura Integral do bastidor",
            "E2- Coloca√ß√£o de fundo e patins",
            "E2-Montagem de suportes, topos, coloca√ß√£o de lona e armazenagem",
            "KC390-Montagem caixa",
            "KC390-Soldadura Integral bastidor",
            "KC390-Fundo e Patins",
            "KC390-Revestimento e armazenagem",
            "KC390 EV-Montagem caixa",
            "KC390 EH-Montagem caixa",
            "KC 390-Embalamento",
            "Praetor-Montagem caixa",
            "Praetor-Soldadura Integral bastidor",
            "Praetor-Fundo e Patins",
            "Praetor-Revestimento e armazenagem",
            "E1-Montagem caixa",
            "Maquina√ß√£o-Montagem",
            "Transporte"
        ];

        const TIPOS = [
            { id: "E2", nome: "E2", icon: "‚úàÔ∏è", cor: "#3b82f6" },
            { id: "E2-Frac", nome: "E2 - Fra√ß√µes", icon: "üì¶", cor: "#60a5fa" },
            { id: "KC390", nome: "KC390", icon: "‚úàÔ∏è", cor: "#10b981" },
            { id: "KC390-Frac", nome: "KC390 - Fra√ß√µes", icon: "üì¶", cor: "#34d399" },
            { id: "Praetor", nome: "Praetor", icon: "‚úàÔ∏è", cor: "#8b5cf6" },
            { id: "E1-Frac", nome: "E1 - Fra√ß√µes", icon: "üì¶", cor: "#f59e0b" },
            { id: "Maquinacao", nome: "Maquina√ß√£o", icon: "‚öôÔ∏è", cor: "#6b7280" },
            { id: "Transporte", nome: "Transportes", icon: "üöõ", cor: "#ef4444" }
        ];

        const TURNOS = {
            'turno1': { nome: 'Turno 1', horas: 7.5 },
            'turno2': { nome: 'Turno 2', horas: 7.5 },
            'normal': { nome: 'Normal', horas: 8 },
            'rotativo': { nome: 'Rotativo', horas: 7.5 }
        };

        const FERIADOS_FIXOS = ['01-01','04-25','05-01','06-10','06-29','08-15','10-05','11-01','12-01','12-08','12-25'];

        // ============================================================
        // FUN√á√ïES
        // ============================================================
        const formatData = d => d ? d.split('-').reverse().join('/') : '';
        const getDiaSemana = d => ['dom','seg','ter','qua','qui','sex','sab'][new Date(d).getDay()];
        
        const parseData = (val) => {
            if (!val) return '';
            // String ISO ou YYYY-MM-DD
            if (typeof val === 'string') {
                if (val.includes('T')) return val.split('T')[0];
                if (val.match(/^\d{4}-\d{2}-\d{2}/)) return val.substring(0, 10);
                // DD/MM/YYYY
                if (val.includes('/')) {
                    const p = val.split('/');
                    if (p[2]?.length === 4) return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                }
                return val;
            }
            // N√∫mero serial Excel (dias desde 1900)
            if (typeof val === 'number') {
                const date = new Date((val - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            return '';
        };

        const parseHora = (val) => {
            if (!val) return '';
            // String HH:MM:SS ou HH:MM
            if (typeof val === 'string') {
                if (val.includes(':')) return val.substring(0, 5);
                return val;
            }
            // Fra√ß√£o do dia (0.5 = 12:00)
            if (typeof val === 'number') {
                const totalMin = Math.round(val * 24 * 60);
                const h = Math.floor(totalMin / 60) % 24;
                const m = totalMin % 60;
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            }
            return '';
        };

        const calcMin = (i, f) => {
            if (!i || !f) return 0;
            const [hi, mi] = i.split(':').map(Number);
            const [hf, mf] = f.split(':').map(Number);
            let m = (hf * 60 + mf) - (hi * 60 + mi);
            return m < 0 ? m + 1440 : m;
        };

        const eFeriado = (data) => FERIADOS_FIXOS.includes(data.slice(5));

        // ============================================================
        // APP
        // ============================================================
        const App = () => {
            const [tab, setTab] = useState('resumo');
            const [loading, setLoading] = useState(false);
            const [ultimaSync, setUltimaSync] = useState(localStorage.getItem('adminUltimaSync') || null);
            
            const hoje = new Date().toISOString().split('T')[0];
            const [dataAtual, setDataAtual] = useState(hoje);
            const [mesAtual, setMesAtual] = useState(hoje.slice(0, 7));
            const [diaInicio, setDiaInicio] = useState(mesAtual + '-01');
            const [diaFim, setDiaFim] = useState(mesAtual + '-' + new Date(mesAtual.split('-')[0], mesAtual.split('-')[1], 0).getDate());

            const [artigosConfig, setArtigosConfig] = useState(() => {
                const s = localStorage.getItem('adminArtigosConfig');
                if (s) {
                    const parsed = JSON.parse(s);
                    // Verificar se cache tem dados antigos (tipo "Frac" em vez de programa correto)
                    if (parsed.some(a => a.tipo === 'Frac')) {
                        localStorage.removeItem('adminArtigosConfig');
                        return ARTIGOS;
                    }
                    return parsed;
                }
                return ARTIGOS;
            });

            const [operacoesConfig, setOperacoesConfig] = useState(() => {
                const s = localStorage.getItem('adminOperacoesConfig');
                return s ? JSON.parse(s) : OPERACOES.map(op => ({ operacao: op, unidade: 'Evora1-Montagem', artigos: '' }));
            });

            const [colaboradores, setColaboradores] = useState(() => {
                const s = localStorage.getItem('adminColabs');
                return s ? JSON.parse(s) : COLABORADORES;
            });

            const [registos, setRegistos] = useState(() => {
                const s = localStorage.getItem('adminRegistos');
                return s ? JSON.parse(s) : [];
            });

            const [perturbacoes, setPerturbacoes] = useState(() => {
                const s = localStorage.getItem('adminPerturbacoes');
                return s ? JSON.parse(s) : [];
            });

            const [mesesGuardados, setMesesGuardados] = useState(() => {
                const s = localStorage.getItem('adminMesesGuardados');
                return s ? JSON.parse(s) : [];
            });

            const [ausencias, setAusencias] = useState(() => {
                const s = localStorage.getItem('adminAusencias');
                return s ? JSON.parse(s) : [];
            });

            const [modalAberto, setModalAberto] = useState(false);
            const [editando, setEditando] = useState(null);
            const [editandoArtigo, setEditandoArtigo] = useState(null);
            const [editandoOp, setEditandoOp] = useState(null);
            const [formArtigo, setFormArtigo] = useState({ artigo: '', tipo: '' });
            const [formOp, setFormOp] = useState({ operacao: '', unidade: '', artigos: '' });
            const [formEdit, setFormEdit] = useState({});
            const [modalDados, setModalDados] = useState({ colab: '', data: '', registos: [] });

            const [feriados, setFeriados] = useState(() => {
                const s = localStorage.getItem('adminFeriados');
                return s ? JSON.parse(s) : [];
            });

            // Sync autom√°tica ao abrir
            useEffect(() => {
                carregarDados();
            }, []);

            // Persist√™ncia
            useEffect(() => { localStorage.setItem('adminColabs', JSON.stringify(colaboradores)); }, [colaboradores]);
            useEffect(() => { localStorage.setItem('adminArtigosConfig', JSON.stringify(artigosConfig)); }, [artigosConfig]);
            useEffect(() => { localStorage.setItem('adminOperacoesConfig', JSON.stringify(operacoesConfig)); }, [operacoesConfig]);
            useEffect(() => { localStorage.setItem('adminAusencias', JSON.stringify(ausencias)); }, [ausencias]);
            useEffect(() => { localStorage.setItem('adminMesesGuardados', JSON.stringify(mesesGuardados)); }, [mesesGuardados]);
            useEffect(() => { localStorage.setItem('adminFeriados', JSON.stringify(feriados)); }, [feriados]);

            // Atualizar datas quando muda o m√™s
            useEffect(() => {
                const [ano, mes] = mesAtual.split('-');
                const ultimoDia = new Date(ano, mes, 0).getDate();
                setDiaInicio(mesAtual + '-01');
                setDiaFim(mesAtual + '-' + String(ultimoDia).padStart(2, '0'));
            }, [mesAtual]);

            // Carregar do Excel
            const carregarDados = async () => {
                setLoading(true);
                console.log('A carregar dados do Excel...');
                
                try {
                    const response = await fetch(CONFIG.URL_LER_REGISTOS, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ acao: 'ler' })
                    });
                    
                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Dados recebidos:', data);

                    // Processar produ√ß√£o - PA retorna array direto
                    let prods = Array.isArray(data) ? data : (data.producao || data.Producao || data.production || []);
                    if (Array.isArray(prods) && prods.length > 0) {
                        const regs = prods.map(r => {
                            // Converter data de n√∫mero Excel para YYYY-MM-DD
                            let dataVal = r.Data || r.data || '';
                            // Se for n√∫mero ou string num√©rica (serial Excel)
                            if (typeof dataVal === 'number' || (typeof dataVal === 'string' && /^\d+$/.test(dataVal))) {
                                const num = typeof dataVal === 'number' ? dataVal : parseInt(dataVal);
                                const date = new Date((num - 25569) * 86400 * 1000);
                                dataVal = date.toISOString().split('T')[0];
                            } else if (typeof dataVal === 'string' && dataVal.includes('/')) {
                                const p = dataVal.split('/');
                                if (p[2]?.length === 4) dataVal = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                            }
                            
                            // Converter hora de fra√ß√£o para HH:MM
                            let horaIni = r['Hora In√≠cio'] || r.HoraInicio || r.horaInicio || '';
                            let horaFim = r['Hora Fim'] || r.HoraFim || r.horaFim || '';
                            
                            // Fun√ß√£o para converter hora
                            const converterHora = (val) => {
                                if (!val) return '';
                                // Se j√° est√° em formato HH:MM
                                if (typeof val === 'string' && val.includes(':')) {
                                    return val.substring(0, 5);
                                }
                                // Se √© n√∫mero ou string num√©rica (fra√ß√£o do dia)
                                let num = typeof val === 'number' ? val : parseFloat(val);
                                if (!isNaN(num)) {
                                    const m = Math.round(num * 24 * 60);
                                    return `${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
                                }
                                return val;
                            };
                            
                            horaIni = converterHora(horaIni);
                            horaFim = converterHora(horaFim);
                            
                            // Normalizar colaborador (primeira letra mai√∫scula)
                            let colab = r.Colaborador || r.colaborador || '';
                            if (colab) {
                                colab = colab.split(' ').map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()).join(' ');
                            }
                            
                            return {
                                id: r.ID || r.id || '',
                                data: dataVal,
                                artigo: r.Artigo || r.artigo || '',
                                tipoCaixa: r['Tipo Caixa'] || r.TipoCaixa || r.tipoCaixa || '',
                                operacao: r['Opera√ß√£o'] || r.Operacao || r.operacao || '',
                                unidade: r['Unidade Produ√ß√£o'] || r.UnidadeProducao || r.unidade || '',
                                colaborador: colab,
                                horaInicio: horaIni,
                                horaFim: horaFim,
                                duracao: r['Dura√ß√£o'] || r.Duracao || r.duracao || '',
                                comentarios: r['Coment√°rios'] || r.Comentarios || r.comentarios || ''
                            };
                        }).filter(r => r.data);
                        
                        // Remover duplicados por ID
                        const regsUnicos = [];
                        const idsVistos = new Set();
                        regs.forEach(r => {
                            const idStr = String(r.id);
                            if (idStr && idStr !== '' && !idsVistos.has(idStr)) {
                                idsVistos.add(idStr);
                                regsUnicos.push(r);
                            } else if (!idStr || idStr === '') {
                                regsUnicos.push(r); // manter registos sem ID
                            }
                        });
                        
                        console.log('Registos processados:', regs.length, '‚Üí √önicos:', regsUnicos.length);
                        console.log('Primeiro registo:', regsUnicos[0]);
                        console.log('Datas √∫nicas:', [...new Set(regsUnicos.map(r => r.data))].slice(0, 10));
                        console.log('Colaboradores √∫nicos:', [...new Set(regsUnicos.map(r => r.colaborador))]);
                        setRegistos(regsUnicos);
                        localStorage.setItem('adminRegistos', JSON.stringify(regsUnicos));
                        
                        // Mapa ser√° guardado manualmente via tab Horas
                        // (removido envio autom√°tico para evitar duplicados)
                    }

                    // Carregar perturba√ß√µes
                    try {
                        const respPert = await fetch(CONFIG.URL_LER_PERTURBACOES, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        });
                        const dataPert = await respPert.json();
                        console.log('Perturba√ß√µes recebidas:', dataPert);
                        
                        let pertsRaw = Array.isArray(dataPert) ? dataPert : [];
                        if (pertsRaw.length > 0) {
                            const perts = pertsRaw.map(p => {
                                // Converter data
                                let dataVal = p.Data || p.data || '';
                                if (typeof dataVal === 'number' || (typeof dataVal === 'string' && /^\d+$/.test(dataVal))) {
                                    const num = typeof dataVal === 'number' ? dataVal : parseInt(dataVal);
                                    const date = new Date((num - 25569) * 86400 * 1000);
                                    dataVal = date.toISOString().split('T')[0];
                                }
                                
                                // Converter horas
                                const converterHora = (val) => {
                                    if (!val) return '';
                                    if (typeof val === 'string' && val.includes(':')) return val.substring(0, 5);
                                    let num = typeof val === 'number' ? val : parseFloat(val);
                                    if (!isNaN(num)) {
                                        const m = Math.round(num * 24 * 60);
                                        return `${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
                                    }
                                    return val;
                                };
                                
                                return {
                                    id: p['ID Registo'] || p.IDRegisto || p.ID || p.id || '',
                                    data: dataVal,
                                    tipo: p['Tipo Perturba√ß√£o'] || p.TipoPerturbacao || p.Tipo || p.tipo || '',
                                    colaborador: p.Colaborador || p.colaborador || '',
                                    horaInicio: converterHora(p['Hora In√≠cio'] || p.HoraInicio || p.horaInicio),
                                    horaFim: converterHora(p['Hora Fim'] || p.HoraFim || p.horaFim),
                                    duracao: p['Dura√ß√£o'] || p.Duracao || p.duracao || ''
                                };
                            }).filter(p => p.data);
                            
                            console.log('Perturba√ß√µes processadas:', perts.length);
                            setPerturbacoes(perts);
                            localStorage.setItem('adminPerturbacoes', JSON.stringify(perts));
                        }
                    } catch (errPert) {
                        console.log('Erro ao carregar perturba√ß√µes:', errPert);
                    }

                    // Carregar configura√ß√µes (colaboradores, artigos, opera√ß√µes, aus√™ncias, feriados)
                    try {
                        const respConfig = await fetch(CONFIG.URL_LER_CONFIG, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        });
                        const dataConfig = await respConfig.json();
                        console.log('Configura√ß√µes recebidas:', dataConfig);
                        
                        // Colaboradores
                        if (dataConfig.colaboradores && dataConfig.colaboradores.length > 0) {
                            const colabs = dataConfig.colaboradores.map(c => ({
                                nome: c.Nome || c.nome || '',
                                turno: (c.Turno || c.turno || 'normal').toLowerCase(),
                                dias: (c.DiasTrabalho || c.diasTrabalho || 'seg,ter,qua,qui,sex').toLowerCase().split(','),
                                ativo: (c.Ativo || c.ativo || 'Sim') === 'Sim'
                            })).filter(c => c.nome);
                            console.log('Colaboradores carregados:', colabs.length);
                            setColaboradores(colabs);
                            localStorage.setItem('adminColabs', JSON.stringify(colabs));
                        }
                        
                        // Artigos
                        if (dataConfig.artigos && dataConfig.artigos.length > 0) {
                            const arts = dataConfig.artigos.map(a => ({
                                artigo: a.Artigo || a.artigo || '',
                                tipo: a.Programa || a.programa || a.Tipo || a.tipo || ''
                            })).filter(a => a.artigo);
                            console.log('Artigos carregados:', arts.length);
                            setArtigosConfig(arts);
                            localStorage.setItem('adminArtigosConfig', JSON.stringify(arts));
                        }
                        
                        // Opera√ß√µes
                        if (dataConfig.operacoes && dataConfig.operacoes.length > 0) {
                            const ops = dataConfig.operacoes.map(o => ({
                                operacao: o.Operacao || o.operacao || '',
                                unidade: o.Unidade || o.unidade || '',
                                artigos: o.Artigos || o.artigos || ''
                            })).filter(o => o.operacao);
                            console.log('Opera√ß√µes carregadas:', ops.length);
                            setOperacoesConfig(ops);
                            localStorage.setItem('adminOperacoesConfig', JSON.stringify(ops));
                        }
                        
                        // Aus√™ncias
                        if (dataConfig.ausencias && dataConfig.ausencias.length > 0) {
                            const parseDataConfig = (val) => {
                                if (!val) return '';
                                if (typeof val === 'number' || (typeof val === 'string' && /^\d+$/.test(val))) {
                                    const num = typeof val === 'number' ? val : parseInt(val);
                                    return new Date((num - 25569) * 86400 * 1000).toISOString().split('T')[0];
                                }
                                if (typeof val === 'string' && val.includes('T')) return val.split('T')[0];
                                return val;
                            };
                            const aus = dataConfig.ausencias.map(a => ({
                                id: a.ID || a.id || Date.now(),
                                nome: a.Nome || a.nome || '',
                                dataInicio: parseDataConfig(a.DataInicio || a.dataInicio),
                                dataFim: parseDataConfig(a.DataFim || a.dataFim),
                                tipo: a.Tipo || a.tipo || ''
                            })).filter(a => a.nome && a.dataInicio);
                            console.log('Aus√™ncias carregadas:', aus.length);
                            setAusencias(aus);
                            localStorage.setItem('adminAusencias', JSON.stringify(aus));
                        }
                        
                        // Mapa Horas - extrair meses j√° guardados
                        if (dataConfig.mapahoras && dataConfig.mapahoras.length > 0) {
                            const meses = [...new Set(dataConfig.mapahoras.map(m => m.Mes || m.mes).filter(m => m))];
                            console.log('Meses j√° guardados no Excel:', meses);
                            setMesesGuardados(meses);
                            localStorage.setItem('adminMesesGuardados', JSON.stringify(meses));
                        }
                        
                        // Feriados
                        if (dataConfig.feriados && dataConfig.feriados.length > 0) {
                            const fers = dataConfig.feriados.map(f => {
                                let data = f.Data || f.data || '';
                                if (typeof data === 'number' || (typeof data === 'string' && /^\d+$/.test(data))) {
                                    const num = typeof data === 'number' ? data : parseInt(data);
                                    data = new Date((num - 25569) * 86400 * 1000).toISOString().split('T')[0];
                                }
                                return {
                                    data: data,
                                    nome: f.Nome || f.nome || ''
                                };
                            }).filter(f => f.data);
                            console.log('Feriados carregados:', fers.length);
                            setFeriados(prev => [...prev.filter(f => f.fixo), ...fers.map(f => ({ ...f, fixo: false }))]);
                            localStorage.setItem('adminFeriados', JSON.stringify(fers));
                        }
                        
                    } catch (errConfig) {
                        console.log('Erro ao carregar configura√ß√µes:', errConfig);
                    }

                    const agora = new Date().toLocaleString('pt-PT');
                    setUltimaSync(agora);
                    localStorage.setItem('adminUltimaSync', agora);
                    alert('‚úÖ Dados carregados!');
                    
                } catch (error) {
                    console.error('Erro:', error);
                    alert('‚ùå Erro ao carregar: ' + error.message);
                }
                setLoading(false);
            };

            // Abrir modal com registos do dia
            const abrirDetalhe = (colab, data) => {
                const nomeLower = colab.nome.toLowerCase();
                const regs = registos.filter(r => r.colaborador.toLowerCase() === nomeLower && r.data === data);
                const perts = perturbacoes.filter(p => p.colaborador.toLowerCase() === nomeLower && p.data === data);
                setModalDados({ colab: colab.nome, data, registos: regs, perturbacoes: perts });
                setModalAberto(true);
            };

            // Iniciar edi√ß√£o
            const iniciarEdicao = (reg) => {
                setEditando(reg.id);
                setFormEdit({
                    id: reg.id,
                    data: reg.data,
                    artigo: reg.artigo,
                    tipoCaixa: reg.tipoCaixa,
                    operacao: reg.operacao,
                    unidade: reg.unidade,
                    colaborador: reg.colaborador,
                    horaInicio: reg.horaInicio,
                    horaFim: reg.horaFim,
                    duracao: reg.duracao,
                    comentarios: reg.comentarios || ''
                });
            };

            // Guardar edi√ß√£o
            const guardarEdicao = async () => {
                if (loading) return;
                const idStr = String(formEdit.id);
                if (!idStr || idStr === '' || idStr === 'undefined') {
                    alert('‚ö†Ô∏è Registo sem ID v√°lido. N√£o √© poss√≠vel editar.');
                    return;
                }
                setLoading(true);
                try {
                    // Calcular dura√ß√£o
                    const mins = calcMin(formEdit.horaInicio, formEdit.horaFim);
                    const duracao = `${Math.floor(mins/60)}h ${mins%60}min`;
                    
                    // Chamar Power Automate
                    await fetch(CONFIG.URL_ALTERAR, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: idStr,
                            Data: formEdit.data,
                            Artigo: formEdit.artigo,
                            TipoCaixa: formEdit.tipoCaixa,
                            Operacao: formEdit.operacao,
                            UnidadeProducao: formEdit.unidade,
                            Colaborador: formEdit.colaborador,
                            HoraInicio: formEdit.horaInicio,
                            HoraFim: formEdit.horaFim,
                            Duracao: duracao,
                            Comentarios: formEdit.comentarios || ''
                        }),
                        mode: 'no-cors'
                    });
                    
                    // Atualizar localmente - apenas o primeiro match para evitar duplicados
                    let atualizado = false;
                    const novos = registos.map(r => {
                        if (!atualizado && String(r.id) === idStr) {
                            atualizado = true;
                            return { ...formEdit, duracao };
                        }
                        return r;
                    });
                    setRegistos(novos);
                    localStorage.setItem('adminRegistos', JSON.stringify(novos));
                    
                    // Atualizar modal
                    const nomeLower = modalDados.colab.toLowerCase();
                    setModalDados({
                        ...modalDados,
                        registos: novos.filter(r => r.colaborador.toLowerCase() === nomeLower && r.data === modalDados.data)
                    });
                    
                    setEditando(null);
                    alert('‚úÖ Registo alterado!');
                } catch (error) {
                    console.error('Erro ao alterar:', error);
                    alert('‚ö†Ô∏è Poss√≠vel erro ao alterar. Fa√ßa Sync para confirmar.');
                    setEditando(null);
                }
                setLoading(false);
            };

            // Eliminar registo de produ√ß√£o
            const eliminarRegisto = async (id) => {
                if (confirm('Eliminar este registo do Excel?')) {
                    try {
                        await fetch(CONFIG.URL_ELIMINAR_PROD, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: String(id) }),
                            mode: 'no-cors'
                        });
                    } catch (error) {
                        console.log('Erro (pode ter funcionado):', error);
                    }
                    
                    // Remover localmente (comparar como string)
                    const idStr = String(id);
                    const novos = registos.filter(r => String(r.id) !== idStr);
                    setRegistos(novos);
                    localStorage.setItem('adminRegistos', JSON.stringify(novos));
                    
                    // Atualizar modal
                    const nomeLower = modalDados.colab.toLowerCase();
                    setModalDados({ 
                        ...modalDados, 
                        registos: novos.filter(r => r.colaborador.toLowerCase() === nomeLower && r.data === modalDados.data) 
                    });
                    
                    alert('‚úÖ Registo eliminado!');
                }
            };

            // Eliminar perturba√ß√£o
            const eliminarPerturbacao = async (id) => {
                if (confirm('Eliminar esta perturba√ß√£o do Excel?')) {
                    try {
                        await fetch(CONFIG.URL_ELIMINAR_PERT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: String(id) }),
                            mode: 'no-cors'
                        });
                    } catch (error) {
                        console.log('Erro (pode ter funcionado):', error);
                    }
                    
                    // Remover localmente (comparar como string)
                    const idStr = String(id);
                    const novos = perturbacoes.filter(p => String(p.id) !== idStr);
                    setPerturbacoes(novos);
                    localStorage.setItem('adminPerturbacoes', JSON.stringify(novos));
                    
                    // Atualizar modal
                    const nomeLower = modalDados.colab.toLowerCase();
                    setModalDados({ 
                        ...modalDados, 
                        perturbacoes: novos.filter(p => p.colaborador.toLowerCase() === nomeLower && p.data === modalDados.data) 
                    });
                    
                    alert('‚úÖ Perturba√ß√£o eliminada!');
                }
            };

            // Fun√ß√£o para guardar mapa de horas automaticamente
            const guardarMapaAuto = async (mes, registosData) => {
                // Verificar se j√° foi guardado (usar localStorage direto para evitar estado stale)
                const guardados = JSON.parse(localStorage.getItem('adminMesesGuardados') || '[]');
                if (guardados.includes(mes)) {
                    console.log('M√™s', mes, 'j√° guardado, ignorando...');
                    return;
                }
                
                const [ano, mesNum] = mes.split('-');
                const ultimoDia = new Date(ano, mesNum, 0).getDate();
                
                // Calcular horas para cada colaborador
                const calcHorasData = (nome, data, regs) => {
                    let m = 0;
                    const nomeLower = nome.toLowerCase();
                    regs.filter(r => r.colaborador.toLowerCase() === nomeLower && r.data === data).forEach(r => {
                        const [h1, m1] = (r.horaInicio || '').split(':').map(Number);
                        const [h2, m2] = (r.horaFim || '').split(':').map(Number);
                        if (!isNaN(h1) && !isNaN(h2)) {
                            m += (h2 * 60 + m2) - (h1 * 60 + m1);
                        }
                    });
                    return m / 60;
                };
                
                const dados = colaboradores.filter(c => c.ativo).map(c => {
                    const row = { Colaborador: c.nome, Mes: mes };
                    let total = 0;
                    for (let d = 1; d <= 31; d++) {
                        const data = mes + '-' + String(d).padStart(2, '0');
                        const h = d <= ultimoDia ? calcHorasData(c.nome, data, registosData) : 0;
                        row[String(d)] = h > 0 ? h.toFixed(1) : '';
                        total += h;
                    }
                    row['Total'] = total.toFixed(1);
                    return row;
                });
                
                // S√≥ guardar se houver dados (total > 0)
                const temDados = dados.some(d => parseFloat(d.Total) > 0);
                if (!temDados) {
                    console.log('M√™s', mes, 'sem dados, ignorando...');
                    return;
                }
                
                // Marcar como guardado ANTES de enviar para evitar duplicados
                const novosGuardados = [...guardados, mes];
                setMesesGuardados(novosGuardados);
                localStorage.setItem('adminMesesGuardados', JSON.stringify(novosGuardados));
                
                try {
                    await fetch(CONFIG.URL_GUARDAR_MAPA, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mes, dados, substituir: true }),
                        mode: 'no-cors'
                    });
                    console.log('Mapa', mes, 'guardado!');
                } catch (e) {
                    console.log('Erro ao guardar mapa (pode ter funcionado):', e);
                }
            };

            // Fun√ß√£o para escrever no Excel via Power Automate
            const escreverConfig = async (acao, tabela, dados) => {
                try {
                    await fetch(CONFIG.URL_ESCREVER_CONFIG, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ acao, tabela, dados }),
                        mode: 'no-cors'
                    });
                    return true;
                } catch (e) {
                    console.log('Erro ao escrever:', e);
                    return false;
                }
            };

            // Calcular horas
            const calcHorasReg = (nome, data) => {
                let m = 0;
                const nomeLower = nome.toLowerCase();
                registos.filter(r => r.colaborador.toLowerCase() === nomeLower && r.data === data).forEach(r => {
                    m += calcMin(r.horaInicio, r.horaFim);
                });
                perturbacoes.filter(p => p.colaborador.toLowerCase() === nomeLower && p.data === data).forEach(p => {
                    m += calcMin(p.horaInicio, p.horaFim);
                });
                return m / 60;
            };

            const getStatusDia = (colab, data) => {
                const ds = getDiaSemana(data);
                if (eFeriado(data) || feriados.find(f => f.data === data)) return 'feriado';
                if (ausencias.find(a => a.nome === colab.nome && data >= a.dataInicio && data <= a.dataFim)) return 'ausencia';
                if (ds === 'sab' || ds === 'dom') return 'fds';
                if (!colab.dias?.includes(ds)) return 'folga';
                
                const horas = calcHorasReg(colab.nome, data);
                const horasEsperadas = TURNOS[colab.turno]?.horas || 8;
                
                if (horas >= horasEsperadas) return 'completo';
                if (horas > 0) return 'parcial';
                return 'semregisto';
            };

            // Gerar dias do per√≠odo
            const diasPeriodo = useMemo(() => {
                const dias = [];
                let d = new Date(diaInicio);
                const fim = new Date(diaFim);
                while (d <= fim) {
                    dias.push(d.toISOString().split('T')[0]);
                    d.setDate(d.getDate() + 1);
                }
                return dias;
            }, [diaInicio, diaFim]);

            // Registos do dia
            const regsDia = useMemo(() => registos.filter(r => r.data === dataAtual), [registos, dataAtual]);
            const pertsDia = useMemo(() => perturbacoes.filter(p => p.data === dataAtual), [perturbacoes, dataAtual]);

            // Por tipo
            const porTipo = useMemo(() => {
                const r = {};
                regsDia.forEach(reg => {
                    const t = reg.tipoCaixa || 'Outro';
                    if (!r[t]) r[t] = { ops: 0, min: 0, regs: [] };
                    r[t].ops++;
                    r[t].min += calcMin(reg.horaInicio, reg.horaFim);
                    r[t].regs.push(reg);
                });
                return r;
            }, [regsDia]);

            // ============================================================
            // RENDER
            // ============================================================
            return (
                <div style={{ minHeight: '100vh', background: '#0f172a' }}>
                    {/* Header */}
                    <div style={{ background: '#1e293b', padding: '15px 20px', borderBottom: '1px solid #334155' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h1 style={{ margin: 0, fontSize: '18px', color: '#e2e8f0' }}>‚öôÔ∏è Administra√ß√£o</h1>
                                <p style={{ margin: '3px 0 0 0', color: '#64748b', fontSize: '11px' }}>
                                    {ultimaSync ? `Sync: ${ultimaSync}` : 'Clique Sync para carregar'}
                                    {registos.length > 0 && ` ‚Ä¢ ${registos.length} registos`}
                                </p>
                            </div>
                            <button className="btn btn-primary" onClick={carregarDados} disabled={loading} style={{ padding: '8px 16px' }}>
                                {loading ? '‚è≥ A carregar...' : 'üîÑ Sync'}
                            </button>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="tab-bar">
                        <button className={tab === 'resumo' ? 'active' : ''} onClick={() => setTab('resumo')}>üìä Resumo</button>
                        <button className={tab === 'calendario' ? 'active' : ''} onClick={() => setTab('calendario')}>üìÖ Calend√°rio</button>
                        <button className={tab === 'horas' ? 'active' : ''} onClick={() => setTab('horas')}>üïê Horas</button>
                        <button className={tab === 'matriz' ? 'active' : ''} onClick={() => setTab('matriz')}>üì¶ Matriz</button>
                        <button className={tab === 'equipa' ? 'active' : ''} onClick={() => setTab('equipa')}>üë• Equipa</button>
                        <button className={tab === 'ausencias' ? 'active' : ''} onClick={() => setTab('ausencias')}>üèñÔ∏è Aus√™ncias</button>
                    </div>

                    <div style={{ padding: '15px' }}>
                        {/* ==================== RESUMO ==================== */}
                        {tab === 'resumo' && (
                            <div>
                                <div className="card">
                                    <div className="mb-2">
                                        <label className="label">üìÖ Data</label>
                                        <input type="date" className="input" value={dataAtual} onChange={e => setDataAtual(e.target.value)} />
                                    </div>
                                    
                                    <div className="grid-2 mb-2">
                                        <div style={{ background: '#0f172a', padding: '12px', borderRadius: '8px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '24px', fontWeight: '700', color: '#3b82f6' }}>{regsDia.length}</div>
                                            <div style={{ fontSize: '11px', color: '#64748b' }}>Opera√ß√µes</div>
                                        </div>
                                        <div style={{ background: '#0f172a', padding: '12px', borderRadius: '8px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '24px', fontWeight: '700', color: '#ef4444' }}>{pertsDia.length}</div>
                                            <div style={{ fontSize: '11px', color: '#64748b' }}>Perturba√ß√µes</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Por tipo de caixa */}
                                {Object.keys(porTipo).length > 0 ? (
                                    Object.entries(porTipo).map(([tipo, d]) => {
                                        const t = TIPOS.find(x => x.id === tipo);
                                        return (
                                            <div key={tipo} className="card" style={{ padding: 0, overflow: 'hidden' }}>
                                                <div style={{ background: '#334155', padding: '10px 12px', display: 'flex', justifyContent: 'space-between' }}>
                                                    <span style={{ fontWeight: '600', color: t?.cor || '#e2e8f0' }}>{t?.icon} {t?.nome || tipo}</span>
                                                    <span>{d.ops} ops ‚Ä¢ {Math.floor(d.min/60)}h {d.min%60}m</span>
                                                </div>
                                                {d.regs.map((r, i) => (
                                                    <div key={i} style={{ padding: '8px 12px', borderBottom: '1px solid #334155', fontSize: '12px' }}>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                            <span style={{ fontWeight: '600' }}>{r.artigo}</span>
                                                            <span style={{ color: '#64748b' }}>{r.horaInicio}-{r.horaFim}</span>
                                                        </div>
                                                        <div style={{ color: '#94a3b8', fontSize: '11px' }}>{r.operacao}</div>
                                                        <div style={{ color: '#64748b', fontSize: '11px' }}>{r.colaborador}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        );
                                    })
                                ) : (
                                    <div className="card" style={{ textAlign: 'center', padding: '30px', color: '#64748b' }}>
                                        {registos.length === 0 ? '‚ö†Ô∏è Clique em Sync para carregar dados' : 'üì≠ Sem registos neste dia'}
                                    </div>
                                )}

                                {/* Perturba√ß√µes do dia */}
                                {pertsDia.length > 0 && (
                                    <div className="card" style={{ padding: 0, overflow: 'hidden' }}>
                                        <div style={{ background: '#991b1b', padding: '10px 12px' }}>
                                            <span style={{ fontWeight: '600' }}>‚ö†Ô∏è Perturba√ß√µes ({pertsDia.length})</span>
                                        </div>
                                        {pertsDia.map((p, i) => (
                                            <div key={i} style={{ padding: '8px 12px', borderBottom: '1px solid #334155', fontSize: '12px' }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                    <span style={{ fontWeight: '600' }}>{p.tipo}</span>
                                                    <span style={{ color: '#64748b' }}>{p.horaInicio}-{p.horaFim}</span>
                                                </div>
                                                <div style={{ color: '#64748b', fontSize: '11px' }}>{p.colaborador}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* ==================== CALEND√ÅRIO ==================== */}
                        {tab === 'calendario' && (
                            <div>
                                <div className="card">
                                    <div className="grid-3 mb-2">
                                        <div>
                                            <label className="label">De</label>
                                            <input type="date" className="input" value={diaInicio} onChange={e => setDiaInicio(e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="label">At√©</label>
                                            <input type="date" className="input" value={diaFim} onChange={e => setDiaFim(e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="label">M√™s</label>
                                            <input type="month" className="input" value={mesAtual} onChange={e => setMesAtual(e.target.value)} />
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', fontSize: '10px' }}>
                                        <span>üü¢ Completo</span>
                                        <span>üü° Parcial</span>
                                        <span>üî¥ Sem registo</span>
                                        <span>üîµ Aus√™ncia</span>
                                        <span>üü£ Feriado</span>
                                        <span>‚ö´ FDS/Folga</span>
                                    </div>
                                </div>

                                <div className="card" style={{ overflow: 'auto', maxHeight: '70vh' }}>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th className="nome-col">Nome</th>
                                                {diasPeriodo.map(d => (
                                                    <th key={d} style={{ minWidth: '28px', fontSize: '10px' }}>
                                                        {d.slice(8)}<br/>
                                                        <span style={{ color: '#64748b' }}>{getDiaSemana(d).charAt(0).toUpperCase()}</span>
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {colaboradores.filter(c => c.ativo).map((colab, i) => (
                                                <tr key={i}>
                                                    <td className="nome-col" style={{ fontSize: '11px' }}>
                                                        {colab.nome.split(' ')[0]} {colab.nome.split(' ').slice(-1)[0]}
                                                    </td>
                                                    {diasPeriodo.map(d => {
                                                        const status = getStatusDia(colab, d);
                                                        const horas = calcHorasReg(colab.nome, d);
                                                        let cls = 'cel-cinza';
                                                        const ds = getDiaSemana(d);
                                                        if (status === 'completo') cls = 'cel-verde';
                                                        else if (status === 'parcial') cls = 'cel-amarelo';
                                                        else if (status === 'semregisto') cls = 'cel-vermelho';
                                                        else if (status === 'ausencia') cls = 'cel-azul';
                                                        else if (status === 'feriado') cls = 'cel-roxo';
                                                        // S√°bado trabalhado = amarelo
                                                        if (ds === 'sab' && horas > 0) cls = 'cel-amarelo';
                                                        
                                                        return (
                                                            <td key={d} className={cls} 
                                                                style={{ cursor: 'pointer' }}
                                                                onClick={() => abrirDetalhe(colab, d)}
                                                                title={`${colab.nome}\n${formatData(d)}\n${horas.toFixed(1)}h - Clique para ver`}>
                                                                {horas > 0 ? horas.toFixed(0) : ''}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* ==================== HORAS ==================== */}
                        {tab === 'horas' && (
                            <div>
                                <div className="card">
                                    <div className="grid-2 mb-2">
                                        <div>
                                            <label className="label">M√™s</label>
                                            <input type="month" className="input" value={mesAtual} onChange={e => setMesAtual(e.target.value)} />
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                                            <div style={{ display: 'flex', gap: '8px' }}>
                                            <button className="btn btn-success" style={{ flex: 1 }} onClick={() => {
                                                const [ano, mes] = mesAtual.split('-');
                                                const ultimoDia = new Date(ano, mes, 0).getDate();
                                                
                                                const dados = colaboradores.filter(c => c.ativo).map(c => {
                                                    const row = { Colaborador: c.nome };
                                                    let total = 0;
                                                    for (let d = 1; d <= ultimoDia; d++) {
                                                        const data = `${ano}-${mes}-${String(d).padStart(2, '0')}`;
                                                        const h = calcHorasReg(c.nome, data);
                                                        row[String(d)] = h > 0 ? h.toFixed(1) : '';
                                                        total += h;
                                                    }
                                                    row['Total'] = total.toFixed(1);
                                                    return row;
                                                });
                                                
                                                const wb = XLSX.utils.book_new();
                                                const ws = XLSX.utils.json_to_sheet(dados);
                                                XLSX.utils.book_append_sheet(wb, ws, 'Mapa Horas');
                                                XLSX.writeFile(wb, `Mapa_Horas_${mesAtual}.xlsx`);
                                            }}>üì• Excel</button>
                                            <button className="btn btn-primary" style={{ flex: 1 }} onClick={async () => {
                                                const [ano, mes] = mesAtual.split('-');
                                                const ultimoDia = new Date(ano, mes, 0).getDate();
                                                
                                                const dados = colaboradores.filter(c => c.ativo).map(c => {
                                                    const row = { Colaborador: c.nome, Mes: mesAtual };
                                                    let total = 0;
                                                    for (let d = 1; d <= 31; d++) {
                                                        const data = `${ano}-${mes}-${String(d).padStart(2, '0')}`;
                                                        const h = d <= ultimoDia ? calcHorasReg(c.nome, data) : 0;
                                                        row[String(d)] = h > 0 ? h.toFixed(1) : '';
                                                        total += h;
                                                    }
                                                    row['Total'] = total.toFixed(1);
                                                    return row;
                                                });
                                                
                                                try {
                                                    await fetch(CONFIG.URL_GUARDAR_MAPA, {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ mes: mesAtual, dados })
                                                    });
                                                    setMesesGuardados(prev => prev.includes(mesAtual) ? prev : [...prev, mesAtual]);
                                                    alert('‚úÖ Mapa guardado no Excel!');
                                                } catch (e) {
                                                    setMesesGuardados(prev => prev.includes(mesAtual) ? prev : [...prev, mesAtual]);
                                                    alert('‚úÖ Mapa enviado!');
                                                }
                                            }}>üíæ Guardar</button>
                                        </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="card" style={{ overflow: 'auto' }}>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th className="nome-col">Colaborador</th>
                                                {(() => {
                                                    const [ano, mes] = mesAtual.split('-');
                                                    const ultimoDia = new Date(ano, mes, 0).getDate();
                                                    const dias = [];
                                                    for (let d = 1; d <= ultimoDia; d++) {
                                                        const data = `${ano}-${mes}-${String(d).padStart(2, '0')}`;
                                                        dias.push(
                                                            <th key={d} style={{ minWidth: '32px', fontSize: '10px' }}>
                                                                {d}<br/>
                                                                <span style={{ color: '#64748b' }}>{getDiaSemana(data).charAt(0).toUpperCase()}</span>
                                                            </th>
                                                        );
                                                    }
                                                    return dias;
                                                })()}
                                                <th style={{ minWidth: '50px', background: '#1e3a5f' }}>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {colaboradores.filter(c => c.ativo).map((colab, i) => {
                                                const [ano, mes] = mesAtual.split('-');
                                                const ultimoDia = new Date(ano, mes, 0).getDate();
                                                let totalMes = 0;
                                                
                                                return (
                                                    <tr key={i}>
                                                        <td className="nome-col" style={{ fontSize: '11px' }}>
                                                            {colab.nome.split(' ')[0]} {colab.nome.split(' ').slice(-1)[0]}
                                                        </td>
                                                        {(() => {
                                                            const celulas = [];
                                                            for (let d = 1; d <= ultimoDia; d++) {
                                                                const data = `${ano}-${mes}-${String(d).padStart(2, '0')}`;
                                                                const h = calcHorasReg(colab.nome, data);
                                                                totalMes += h;
                                                                const ds = getDiaSemana(data);
                                                                const fds = ds === 'sab' || ds === 'dom';
                                                                const fer = eFeriado(data);
                                                                
                                                                let bg = '#1e293b';
                                                                if (fer) bg = '#5b21b6';
                                                                else if (fds && h > 0) bg = '#92400e';
                                                                else if (fds) bg = '#334155';
                                                                else if (h >= 8) bg = '#065f46';
                                                                else if (h > 0) bg = '#92400e';
                                                                
                                                                celulas.push(
                                                                    <td key={d} style={{ background: bg, fontSize: '11px' }}>
                                                                        {h > 0 ? h.toFixed(0) : ''}
                                                                    </td>
                                                                );
                                                            }
                                                            return celulas;
                                                        })()}
                                                        <td style={{ background: '#1e3a5f', fontWeight: '600', fontSize: '12px' }}>
                                                            {totalMes.toFixed(1)}h
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot>
                                            <tr style={{ background: '#334155' }}>
                                                <td className="nome-col" style={{ fontWeight: '600' }}>TOTAL</td>
                                                {(() => {
                                                    const [ano, mes] = mesAtual.split('-');
                                                    const ultimoDia = new Date(ano, mes, 0).getDate();
                                                    const totais = [];
                                                    let grandeTotal = 0;
                                                    
                                                    for (let d = 1; d <= ultimoDia; d++) {
                                                        const data = `${ano}-${mes}-${String(d).padStart(2, '0')}`;
                                                        let totalDia = 0;
                                                        colaboradores.filter(c => c.ativo).forEach(c => {
                                                            totalDia += calcHorasReg(c.nome, data);
                                                        });
                                                        grandeTotal += totalDia;
                                                        totais.push(
                                                            <td key={d} style={{ fontSize: '10px', fontWeight: '600' }}>
                                                                {totalDia > 0 ? totalDia.toFixed(0) : ''}
                                                            </td>
                                                        );
                                                    }
                                                    totais.push(
                                                        <td key="total" style={{ background: '#1e3a5f', fontWeight: '700', fontSize: '12px' }}>
                                                            {grandeTotal.toFixed(0)}h
                                                        </td>
                                                    );
                                                    return totais;
                                                })()}
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* ==================== MATRIZ ==================== */}
                        {tab === 'matriz' && (
                            <div>
                                {/* Artigos */}
                                <div className="card">
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                        <h3 style={{ margin: 0, fontSize: '16px' }}>üì¶ Artigos ({artigosConfig.length})</h3>
                                        <button className="btn btn-success" style={{ padding: '6px 10px', fontSize: '11px' }} onClick={() => {
                                            const wb = XLSX.utils.book_new();
                                            const ws = XLSX.utils.json_to_sheet(artigosConfig.map(a => ({ Artigo: a.artigo, Tipo: a.tipo })));
                                            XLSX.utils.book_append_sheet(wb, ws, 'Artigos');
                                            XLSX.writeFile(wb, 'ConfigArtigos.xlsx');
                                        }}>üì• Excel</button>
                                    </div>
                                    
                                    {TIPOS.map(tipo => {
                                        const arts = artigosConfig.filter(a => a.tipo === tipo.id);
                                        if (!arts.length) return null;
                                        return (
                                            <div key={tipo.id} style={{ marginBottom: '12px' }}>
                                                <div style={{ background: '#334155', padding: '8px 12px', borderRadius: '6px', marginBottom: '6px', fontWeight: '600', fontSize: '13px', color: tipo.cor }}>
                                                    {tipo.icon} {tipo.nome} ({arts.length})
                                                </div>
                                                {arts.map((a, i) => (
                                                    <div key={i} style={{ background: '#0f172a', borderRadius: '4px', marginBottom: '3px', padding: '6px 12px' }}>
                                                        {editandoArtigo === a.artigo ? (
                                                            <div>
                                                                <div className="grid-2" style={{ gap: '6px', marginBottom: '6px' }}>
                                                                    <input className="input" value={formArtigo.artigo} onChange={e => setFormArtigo({...formArtigo, artigo: e.target.value})} style={{ padding: '6px', fontSize: '11px' }} />
                                                                    <select className="input" value={formArtigo.tipo} onChange={e => setFormArtigo({...formArtigo, tipo: e.target.value})} style={{ padding: '6px', fontSize: '11px' }}>
                                                                        {TIPOS.map(t => <option key={t.id} value={t.id}>{t.nome}</option>)}
                                                                    </select>
                                                                </div>
                                                                <div style={{ display: 'flex', gap: '4px' }}>
                                                                    <button className="btn btn-success" style={{ flex: 1, padding: '4px', fontSize: '10px' }} onClick={() => {
                                                                        setArtigosConfig(artigosConfig.map(x => x.artigo === editandoArtigo ? { artigo: formArtigo.artigo, tipo: formArtigo.tipo } : x));
                                                                        setEditandoArtigo(null);
                                                                    }}>üíæ</button>
                                                                    <button className="btn btn-secondary" style={{ padding: '4px 8px', fontSize: '10px' }} onClick={() => setEditandoArtigo(null)}>‚úï</button>
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '12px' }}>
                                                                <span>{a.artigo}</span>
                                                                <div style={{ display: 'flex', gap: '4px' }}>
                                                                    <button className="btn btn-primary" style={{ padding: '2px 6px', fontSize: '10px' }} onClick={() => {
                                                                        setFormArtigo({ artigo: a.artigo, tipo: a.tipo });
                                                                        setEditandoArtigo(a.artigo);
                                                                    }}>‚úèÔ∏è</button>
                                                                    <button className="btn btn-danger" style={{ padding: '2px 6px', fontSize: '10px' }} onClick={() => {
                                                                        if (confirm('Remover "' + a.artigo + '"?')) {
                                                                            setArtigosConfig(artigosConfig.filter(x => x.artigo !== a.artigo));
                                                                        }
                                                                    }}>‚úï</button>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        );
                                    })}
                                    
                                    {/* Adicionar artigo */}
                                    <div style={{ marginTop: '15px', padding: '12px', background: '#334155', borderRadius: '8px' }}>
                                        <div style={{ fontSize: '12px', fontWeight: '600', marginBottom: '8px' }}>‚ûï Adicionar Artigo</div>
                                        <div className="grid-2" style={{ gap: '8px' }}>
                                            <input type="text" className="input" placeholder="Nome do artigo" id="novoArtNome" style={{ padding: '8px', fontSize: '12px' }} />
                                            <select className="input" id="novoArtTipo" style={{ padding: '8px', fontSize: '12px' }}>
                                                <option value="">Tipo...</option>
                                                {TIPOS.map(t => <option key={t.id} value={t.id}>{t.nome}</option>)}
                                            </select>
                                        </div>
                                        <button className="btn btn-primary" style={{ width: '100%', marginTop: '8px', padding: '8px', fontSize: '12px' }} onClick={async () => {
                                            const nome = document.getElementById('novoArtNome').value.trim();
                                            const tipo = document.getElementById('novoArtTipo').value;
                                            if (!nome || !tipo) { alert('Preencha nome e tipo!'); return; }
                                            if (artigosConfig.find(a => a.artigo === nome)) { alert('Artigo j√° existe!'); return; }
                                            const novos = [...artigosConfig, { artigo: nome, tipo }];
                                            setArtigosConfig(novos);
                                            document.getElementById('novoArtNome').value = '';
                                            document.getElementById('novoArtTipo').value = '';
                                            // Sincronizar com Excel
                                            await escreverConfig('adicionar', 'artigos', { Artigo: nome, Tipo: tipo });
                                        }}>Adicionar</button>
                                    </div>
                                </div>
                                
                                {/* Opera√ß√µes */}
                                <div className="card">
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                        <h3 style={{ margin: 0, fontSize: '16px' }}>‚öôÔ∏è Opera√ß√µes ({operacoesConfig.length})</h3>
                                        <button className="btn btn-success" style={{ padding: '6px 10px', fontSize: '11px' }} onClick={() => {
                                            const wb = XLSX.utils.book_new();
                                            const ws = XLSX.utils.json_to_sheet(operacoesConfig.map(o => ({ Operacao: o.operacao, Unidade: o.unidade, Artigos: o.artigos })));
                                            XLSX.utils.book_append_sheet(wb, ws, 'Operacoes');
                                            XLSX.writeFile(wb, 'ConfigOperacoes.xlsx');
                                        }}>üì• Excel</button>
                                    </div>
                                    
                                    {operacoesConfig.map((op, i) => (
                                        <div key={i} style={{ background: '#0f172a', padding: '10px', borderRadius: '6px', marginBottom: '6px' }}>
                                            {editandoOp === i ? (
                                                <div>
                                                    <input className="input mb-2" value={formOp.operacao} onChange={e => setFormOp({...formOp, operacao: e.target.value})} placeholder="Opera√ß√£o" style={{ padding: '6px', fontSize: '11px' }} />
                                                    <select className="input mb-2" value={formOp.unidade} onChange={e => setFormOp({...formOp, unidade: e.target.value})} style={{ padding: '6px', fontSize: '11px' }}>
                                                        <option value="Evora1-Soldadura">√âvora 1 - Soldadura</option>
                                                        <option value="Evora1-Montagem">√âvora 1 - Montagem</option>
                                                        <option value="Evora1-Embalamento">√âvora 1 - Embalamento</option>
                                                        <option value="Evora2-Soldadura">√âvora 2 - Soldadura</option>
                                                        <option value="Evora2-Montagem">√âvora 2 - Montagem</option>
                                                    </select>
                                                    <input className="input mb-2" value={formOp.artigos} onChange={e => setFormOp({...formOp, artigos: e.target.value})} placeholder="Artigos (v√≠rgula)" style={{ padding: '6px', fontSize: '11px' }} />
                                                    <div style={{ display: 'flex', gap: '4px' }}>
                                                        <button className="btn btn-success" style={{ flex: 1, padding: '4px', fontSize: '10px' }} onClick={() => {
                                                            setOperacoesConfig(operacoesConfig.map((x, idx) => idx === i ? { ...formOp } : x));
                                                            setEditandoOp(null);
                                                        }}>üíæ Guardar</button>
                                                        <button className="btn btn-secondary" style={{ padding: '4px 8px', fontSize: '10px' }} onClick={() => setEditandoOp(null)}>Cancelar</button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: '600', fontSize: '12px' }}>{op.operacao}</div>
                                                        <div style={{ fontSize: '11px', color: '#64748b', marginTop: '2px' }}>{op.unidade}</div>
                                                        {op.artigos && <div style={{ fontSize: '10px', color: '#94a3b8', marginTop: '4px' }}>üì¶ {op.artigos}</div>}
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '4px' }}>
                                                        <button className="btn btn-primary" style={{ padding: '2px 6px', fontSize: '10px' }} onClick={() => {
                                                            setFormOp({ operacao: op.operacao, unidade: op.unidade, artigos: op.artigos || '' });
                                                            setEditandoOp(i);
                                                        }}>‚úèÔ∏è</button>
                                                        <button className="btn btn-danger" style={{ padding: '2px 6px', fontSize: '10px' }} onClick={() => {
                                                            if (confirm('Remover "' + op.operacao + '"?')) {
                                                                setOperacoesConfig(operacoesConfig.filter((_, idx) => idx !== i));
                                                            }
                                                        }}>‚úï</button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    
                                    {/* Adicionar opera√ß√£o */}
                                    <div style={{ marginTop: '15px', padding: '12px', background: '#334155', borderRadius: '8px' }}>
                                        <div style={{ fontSize: '12px', fontWeight: '600', marginBottom: '8px' }}>‚ûï Adicionar Opera√ß√£o</div>
                                        <input type="text" className="input mb-2" placeholder="Nome da opera√ß√£o" id="novaOpNome" style={{ padding: '8px', fontSize: '12px' }} />
                                        <select className="input mb-2" id="novaOpUnidade" style={{ padding: '8px', fontSize: '12px' }}>
                                            <option value="">Unidade...</option>
                                            <option value="Evora1-Soldadura">√âvora 1 - Soldadura</option>
                                            <option value="Evora1-Montagem">√âvora 1 - Montagem</option>
                                            <option value="Evora1-Embalamento">√âvora 1 - Embalamento</option>
                                            <option value="Evora2-Soldadura">√âvora 2 - Soldadura</option>
                                            <option value="Evora2-Montagem">√âvora 2 - Montagem</option>
                                        </select>
                                        <input type="text" className="input mb-2" placeholder="Artigos (separados por v√≠rgula)" id="novaOpArtigos" style={{ padding: '8px', fontSize: '12px' }} />
                                        <button className="btn btn-primary" style={{ width: '100%', padding: '8px', fontSize: '12px' }} onClick={async () => {
                                            const nome = document.getElementById('novaOpNome').value.trim();
                                            const unidade = document.getElementById('novaOpUnidade').value;
                                            const artigos = document.getElementById('novaOpArtigos').value.trim();
                                            if (!nome || !unidade) { alert('Preencha nome e unidade!'); return; }
                                            const novos = [...operacoesConfig, { operacao: nome, unidade, artigos }];
                                            setOperacoesConfig(novos);
                                            document.getElementById('novaOpNome').value = '';
                                            document.getElementById('novaOpUnidade').value = '';
                                            document.getElementById('novaOpArtigos').value = '';
                                            // Sincronizar com Excel
                                            await escreverConfig('adicionar', 'operacoes', { Operacao: nome, Unidade: unidade, Artigos: artigos });
                                        }}>Adicionar</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ==================== EQUIPA ==================== */}
                        {tab === 'equipa' && (
                            <div>
                                {colaboradores.map((c, i) => (
                                    <div key={i} className="card">
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                                            <span style={{ fontWeight: '600', fontSize: '13px' }}>{c.nome}</span>
                                            <button 
                                                className={c.ativo ? 'btn btn-success' : 'btn btn-secondary'}
                                                style={{ padding: '4px 10px', fontSize: '11px' }}
                                                onClick={() => {
                                                    const novos = [...colaboradores];
                                                    novos[i].ativo = !novos[i].ativo;
                                                    setColaboradores(novos);
                                                }}
                                            >
                                                {c.ativo ? '‚úì Ativo' : 'Inativo'}
                                            </button>
                                        </div>
                                        <select className="input" value={c.turno} style={{ marginBottom: '8px' }} onChange={e => {
                                            const novos = [...colaboradores];
                                            novos[i].turno = e.target.value;
                                            setColaboradores(novos);
                                        }}>
                                            <option value="normal">Normal (8h)</option>
                                            <option value="turno1">Turno 1 (7.5h)</option>
                                            <option value="turno2">Turno 2 (7.5h)</option>
                                            <option value="rotativo">Rotativo</option>
                                        </select>
                                        <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                                            {['seg','ter','qua','qui','sex','sab'].map(d => (
                                                <button 
                                                    key={d}
                                                    className={c.dias?.includes(d) ? 'btn btn-primary' : 'btn btn-secondary'}
                                                    style={{ padding: '4px 8px', fontSize: '10px' }}
                                                    onClick={() => {
                                                        const novos = [...colaboradores];
                                                        const dias = novos[i].dias || [];
                                                        novos[i].dias = dias.includes(d) ? dias.filter(x => x !== d) : [...dias, d];
                                                        setColaboradores(novos);
                                                    }}
                                                >
                                                    {d.toUpperCase()}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* ==================== AUS√äNCIAS ==================== */}
                        {tab === 'ausencias' && (
                            <div>
                                <div className="card">
                                    <h3 style={{ margin: '0 0 10px 0', fontSize: '14px' }}>‚ûï Nova Aus√™ncia</h3>
                                    <select className="input mb-2" id="ausNome">
                                        <option value="">Colaborador...</option>
                                        {colaboradores.filter(c => c.ativo).map((c, i) => <option key={i} value={c.nome}>{c.nome}</option>)}
                                    </select>
                                    <select className="input mb-2" id="ausTipo">
                                        <option value="">Tipo...</option>
                                        <option value="F√©rias">üèñÔ∏è F√©rias</option>
                                        <option value="Baixa">üè• Baixa</option>
                                        <option value="Falta">‚ùå Falta</option>
                                    </select>
                                    <div className="grid-2 mb-2">
                                        <input type="date" className="input" id="ausIni" />
                                        <input type="date" className="input" id="ausFim" />
                                    </div>
                                    <button className="btn btn-primary" style={{ width: '100%' }} onClick={() => {
                                        const nome = document.getElementById('ausNome').value;
                                        const tipo = document.getElementById('ausTipo').value;
                                        const ini = document.getElementById('ausIni').value;
                                        const fim = document.getElementById('ausFim').value;
                                        if (!nome || !tipo || !ini || !fim) { alert('Preencha tudo!'); return; }
                                        setAusencias([...ausencias, { id: Date.now(), nome, tipo, dataInicio: ini, dataFim: fim }]);
                                        document.getElementById('ausNome').value = '';
                                        document.getElementById('ausTipo').value = '';
                                        alert('‚úÖ Aus√™ncia registada!');
                                    }}>Registar</button>
                                </div>

                                {ausencias.length > 0 && (
                                    <div className="card">
                                        <h3 style={{ margin: '0 0 10px 0', fontSize: '14px' }}>üìã Aus√™ncias ({ausencias.length})</h3>
                                        {ausencias.map((a, i) => (
                                            <div key={a.id || i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px', background: '#0f172a', borderRadius: '6px', marginBottom: '6px', fontSize: '12px' }}>
                                                <div>
                                                    <div style={{ fontWeight: '600' }}>{a.nome}</div>
                                                    <div style={{ color: '#64748b' }}>{a.tipo} ‚Ä¢ {formatData(a.dataInicio)} ‚Üí {formatData(a.dataFim)}</div>
                                                </div>
                                                <button className="btn btn-danger" style={{ padding: '4px 8px', fontSize: '10px' }} onClick={() => setAusencias(ausencias.filter(x => x.id !== a.id))}>üóëÔ∏è</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Modal de detalhes */}
                    {modalAberto && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                            <div style={{ background: '#1e293b', borderRadius: '12px', width: '100%', maxWidth: '500px', maxHeight: '80vh', overflow: 'auto' }}>
                                <div style={{ padding: '15px', borderBottom: '1px solid #334155', display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, background: '#1e293b' }}>
                                    <div>
                                        <h3 style={{ margin: 0, fontSize: '16px' }}>{modalDados.colab}</h3>
                                        <p style={{ margin: '3px 0 0 0', color: '#64748b', fontSize: '13px' }}>{formatData(modalDados.data)}</p>
                                    </div>
                                    <button className="btn btn-secondary" onClick={() => setModalAberto(false)}>‚úï</button>
                                </div>
                                
                                <div style={{ padding: '15px' }}>
                                    {modalDados.registos.length === 0 ? (
                                        <p style={{ color: '#64748b', textAlign: 'center' }}>Sem registos</p>
                                    ) : (
                                        <>
                                            <div style={{ marginBottom: '10px', color: '#94a3b8', fontSize: '12px' }}>
                                                Total: {modalDados.registos.length} registos ‚Ä¢ {(modalDados.registos.reduce((acc, r) => acc + calcMin(r.horaInicio, r.horaFim), 0) / 60).toFixed(1)}h
                                                {modalDados.perturbacoes?.length > 0 && <span style={{ color: '#f87171' }}> | {modalDados.perturbacoes.length} perturba√ß√µes</span>}
                                            </div>
                                            {modalDados.registos.sort((a, b) => a.horaInicio.localeCompare(b.horaInicio)).map((r, i) => (
                                                <div key={r.id || i} style={{ background: '#0f172a', borderRadius: '8px', padding: '12px', marginBottom: '8px' }}>
                                                    {editando === r.id ? (
                                                        <div>
                                                            <div style={{ marginBottom: '8px' }}>
                                                                <label style={{ fontSize: '11px', color: '#64748b' }}>Tipo</label>
                                                                <select className="input" value={formEdit.tipoCaixa || ''} onChange={e => setFormEdit({...formEdit, tipoCaixa: e.target.value, artigo: ''})} style={{ padding: '8px', fontSize: '12px' }}>
                                                                    <option value="">Selecionar tipo...</option>
                                                                    {TIPOS.map(t => <option key={t.id} value={t.id}>{t.icon} {t.nome}</option>)}
                                                                </select>
                                                            </div>
                                                            <div style={{ marginBottom: '8px' }}>
                                                                <label style={{ fontSize: '11px', color: '#64748b' }}>Artigo</label>
                                                                <select className="input" value={formEdit.artigo || ''} onChange={e => {
                                                                    const art = ARTIGOS.find(a => a.artigo === e.target.value);
                                                                    setFormEdit({...formEdit, artigo: e.target.value, tipoCaixa: art?.tipo || formEdit.tipoCaixa});
                                                                }} style={{ padding: '8px', fontSize: '12px' }}>
                                                                    <option value="">Selecionar artigo...</option>
                                                                    {ARTIGOS.filter(a => !formEdit.tipoCaixa || a.tipo === formEdit.tipoCaixa).map(a => <option key={a.artigo} value={a.artigo}>{a.artigo}</option>)}
                                                                </select>
                                                            </div>
                                                            <div style={{ marginBottom: '8px' }}>
                                                                <label style={{ fontSize: '11px', color: '#64748b' }}>Opera√ß√£o</label>
                                                                <select className="input" value={formEdit.operacao || ''} onChange={e => setFormEdit({...formEdit, operacao: e.target.value})} style={{ padding: '8px', fontSize: '12px' }}>
                                                                    <option value="">Selecionar opera√ß√£o...</option>
                                                                    {OPERACOES.map(op => <option key={op} value={op}>{op}</option>)}
                                                                </select>
                                                            </div>
                                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '8px' }}>
                                                                <div>
                                                                    <label style={{ fontSize: '11px', color: '#64748b' }}>In√≠cio</label>
                                                                    <input type="time" className="input" value={formEdit.horaInicio} onChange={e => setFormEdit({...formEdit, horaInicio: e.target.value})} style={{ padding: '8px', fontSize: '12px' }} />
                                                                </div>
                                                                <div>
                                                                    <label style={{ fontSize: '11px', color: '#64748b' }}>Fim</label>
                                                                    <input type="time" className="input" value={formEdit.horaFim} onChange={e => setFormEdit({...formEdit, horaFim: e.target.value})} style={{ padding: '8px', fontSize: '12px' }} />
                                                                </div>
                                                            </div>
                                                            <div style={{ marginBottom: '8px' }}>
                                                                <label style={{ fontSize: '11px', color: '#64748b' }}>Coment√°rios</label>
                                                                <input className="input" value={formEdit.comentarios} onChange={e => setFormEdit({...formEdit, comentarios: e.target.value})} style={{ padding: '8px', fontSize: '12px' }} />
                                                            </div>
                                                            <div style={{ display: 'flex', gap: '8px' }}>
                                                                <button className="btn btn-success" style={{ flex: 1, padding: '8px', fontSize: '12px' }} onClick={guardarEdicao}>üíæ Guardar</button>
                                                                <button className="btn btn-secondary" style={{ padding: '8px', fontSize: '12px' }} onClick={() => setEditando(null)}>Cancelar</button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                            <div style={{ flex: 1 }}>
                                                                <div style={{ fontWeight: '600', fontSize: '13px' }}>{r.artigo}</div>
                                                                <div style={{ color: '#94a3b8', fontSize: '11px', marginTop: '2px' }}>{r.operacao}</div>
                                                                <div style={{ color: '#3b82f6', fontSize: '12px', marginTop: '4px' }}>
                                                                    {r.horaInicio} - {r.horaFim} ({r.duracao || calcMin(r.horaInicio, r.horaFim) + 'min'})
                                                                </div>
                                                                {r.comentarios && <div style={{ color: '#64748b', fontSize: '11px', marginTop: '4px' }}>üí¨ {r.comentarios}</div>}
                                                            </div>
                                                            <div style={{ display: 'flex', gap: '4px' }}>
                                                                <button className="btn btn-primary" style={{ padding: '4px 8px', fontSize: '10px' }} onClick={() => iniciarEdicao(r)}>‚úèÔ∏è</button>
                                                                <button className="btn btn-danger" style={{ padding: '4px 8px', fontSize: '10px' }} onClick={() => eliminarRegisto(r.id)}>üóëÔ∏è</button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </>
                                    )}
                                    
                                    {/* Perturba√ß√µes */}
                                    {modalDados.perturbacoes && modalDados.perturbacoes.length > 0 && (
                                        <div style={{ marginTop: '15px', borderTop: '1px solid #334155', paddingTop: '15px' }}>
                                            <div style={{ marginBottom: '10px', color: '#ef4444', fontSize: '13px', fontWeight: '600' }}>
                                                ‚ö†Ô∏è Perturba√ß√µes ({modalDados.perturbacoes.length})
                                            </div>
                                            {modalDados.perturbacoes.map((p, i) => (
                                                <div key={p.id || i} style={{ background: '#450a0a', borderRadius: '8px', padding: '10px', marginBottom: '6px' }}>
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ fontWeight: '600', fontSize: '13px', color: '#fca5a5' }}>{p.tipo}</div>
                                                            <div style={{ color: '#f87171', fontSize: '12px', marginTop: '4px' }}>
                                                                {p.horaInicio} - {p.horaFim} ({p.duracao || calcMin(p.horaInicio, p.horaFim) + 'min'})
                                                            </div>
                                                        </div>
                                                        <button className="btn btn-danger" style={{ padding: '4px 8px', fontSize: '10px' }} onClick={() => eliminarPerturbacao(p.id)}>üóëÔ∏è</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <script>
        // Registar Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw-admin.js')
                .then(reg => console.log('SW Admin registado:', reg.scope))
                .catch(err => console.log('SW Admin erro:', err));
        }
    </script>
</body>
</html>
